<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
		"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	  xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	  xmlns:h="http://xmlns.jcp.org/jsf/html"
	  xmlns:f="http://xmlns.jcp.org/jsf/core"
	  xmlns:p="http://primefaces.org/ui"
>

<f:metadata>
	<f:viewParam name="gameId" required="true" value="#{boardController.gameId}"/>
	<f:viewAction action="#{boardController.init}"/>
</f:metadata>

<ui:composition template="../layout.xhtml">

	<ui:define name="content">

		<h:form id="form">
			<p:panel id="board" header="Plansza">

				<ul>
					<li><h:outputText value="X: #{boardController.game.playerX}"/></li>
					<li><h:outputText value="O: #{boardController.game.playerO}"/></li>
					<li><h:outputText value="Ruch gracza: #{boardController.game.nextPlayer}"/></li>
				</ul>

				<p:growl widgetVar="growl"/>
				<p:separator />

				<table>
					<ui:repeat value="#{boardController.game.board}" var="firstLevel" varStatus="xIndex">
						<tr align="center">

							<ui:repeat value="#{firstLevel}" var="secondLevel" varStatus="yIndex"
									   rendered="#{!empty firstLevel}">

								<td align="center"
									onclick="handleClick(
									'#{empty boardController.convertSign(secondLevel) and boardController.moveDisabled}',
									'#{xIndex.index}',
									'#{yIndex.index}')">
									#{boardController.convertSign(secondLevel)}
								</td>

							</ui:repeat>

							<h:panelGroup rendered="#{empty firstLevel}">
								<td colspan="3">empty</td>
							</h:panelGroup>
						</tr>
					</ui:repeat>
				</table>
				<p:separator />
			</p:panel>

			<script type="text/javascript">
				function handleClick(clickable, x, y) {
					console.log('clickable: ' + clickable);
					if (clickable == 'true') {
						makeMove([{name: 'x', value: x}, {name: 'y', value: y}]);
					}
				}
			</script>

			<p:remoteCommand name="makeMove" actionListener="#{boardController.makeMove}"/>
			<p:socket channel="/board/#{loginController.username}">
				<p:ajax event="message" update="form:board" />
			</p:socket>

			<p:socket onMessage="handleMessage" channel="/board/message/#{loginController.username}"/>
			<script type="text/javascript">
				function handleMessage(facesmessage) {
					facesmessage.severity = 'info';
					PF('growl').show([facesmessage]);
				}
			</script>
			<style type="text/css">
				table {
					border-collapse: collapse;
					border: 1px solid black;
					table-layout: fixed;
					width: 200px;
				}

				th, td {
					border: 1px solid black;
					overflow: hidden;
					width: 100px;
					height: 100px;
				}
			</style>
		</h:form>
	</ui:define>

</ui:composition>
</html>
